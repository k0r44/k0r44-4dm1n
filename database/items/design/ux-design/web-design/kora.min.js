// Access Firestore collection
const db = firebase.firestore().collection("/koraa/items/design/ux design/web design/");
const userCollection = firebase.firestore().collection("users");

// Get the form element
var myForm = document.getElementById('myForm');

// Listen for form submission
myForm.addEventListener('submit', function(e) {
  e.preventDefault();

  // Get form values
  var img = document.getElementById('img').value;
  var name = document.getElementById('name').value;
  var author = document.getElementById('author').value;
  var preview = document.getElementById('preview').value;

  // Get the current user's UID
  var user = firebase.auth().currentUser;
  var uid = user.uid;

  // Generate a new document ID
  var newDocRef = db.doc();

  // Save data to Firestore with the same document ID
  newDocRef.set({
    img: img,
    name: name,
    author: author,
    preview: preview
  })
  .then(function() {
    alert('Form submitted successfully');
    myForm.reset();
    console.log('Document written with UID: ', uid);

    // Create a new collection "items" within the user's document
    var userItemsCollection = userCollection.doc(uid).collection("items");

    // Save data to userItemsCollection with the same document ID
    userItemsCollection.doc(newDocRef.id).set({
      img: img,
      name: name,
      author: author,
      preview: preview
    })
    .then(function() {
      console.log('Item added to "items" collection with ID: ', newDocRef.id);
    })
    .catch(function(error) {
      console.error('Error adding item to "items" collection: ', error);
    });
  })
  .catch(function(error) {
    console.error('Error adding document: ', error);
  });
});

// Upload image to Firebase Storage
var storageRef = firebase.storage().ref();

document.getElementById('fileButton').addEventListener('change', function(e) {
  var file = e.target.files[0];
  var fileName = Date.now() + '_' + file.name;

  // Get the current user's UID
  var user = firebase.auth().currentUser;
  var uid = user.uid;

  var uploadTask = storageRef.child('/koraa/items/design/ux design/web design/' + uid + '/' + fileName).put(file);

  uploadTask.on('state_changed', function(snapshot) {
    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
    console.log('Upload is ' + progress + '% done');
  }, function(error) {
    console.error('Error uploading file: ', error);
  }, function() {
    uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
      console.log('File available at', downloadURL);
      document.getElementById('img').value = downloadURL;
    });
  });
});
