<!DOCTYPE html>
<html>
<head>
  <title>Login and Daftar Firebase</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Login and Daftar Firebase</h1>
    <div id="login-form">
      <h2>Masuk</h2>
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button onclick="login()">Masuk</button>
    </div>
    <div id="signup-form">
      <h2>Daftar</h2>
      <input type="email" id="new-email" placeholder="Email" required>
      <input type="password" id="new-password" placeholder="Password" required>
      <select id="kategori" required>
        <option value="">Pilih Kategori</option>
        <option value="code">Code</option>
        <option value="design">Design</option>
      </select>
      <button onclick="signup()">Daftar</button>
    </div>
    <div id="success-message"></div>
    <div id="error-message"></div>
  </div>

  <div id="category-content"></div>

  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_2_DrjTzs1cIOY9_5mloWYcdLxpsFq5c",
authDomain: "koraa-id.firebaseapp.com",
projectId: "koraa-id",
storageBucket: "koraa-id.appspot.com",
messagingSenderId: "360256061577",
appId: "1:360256061577:web:5d9dbb92ff3313c7b48658",
measurementId: "G-VJT00SD3NT"
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // Get elements
    var loginForm = document.getElementById('login-form');
    var signupForm = document.getElementById('signup-form');
    var successMessage = document.getElementById('success-message');
    var errorMessage = document.getElementById('error-message');
    var categoryContent = document.getElementById('category-content');

    // Show login form
    function showLoginForm() {
      loginForm.style.display = 'block';
      signupForm.style.display = 'block';
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      categoryContent.innerHTML = '';
    }

    // Perform login
    function login() {
      var email = document.getElementById('email').value;
      var password = document.getElementById('password').value;

      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(function(userCredential) {
          var user = userCredential.user;
          loadCategoryPage(user.uid); // Load the category page dynamically using AJAX

          // Check if the current URL is already the category page
          if (!window.location.href.includes('/items/category/' + category + '/')) {
            window.location.href = '/items/category/' + category + '/'; // Redirect to the category page
          }
        })
        .catch(function(error) {
          errorMessage.innerHTML = error.message;
          errorMessage.style.display = 'block';
        });
    }

    // Perform signup
    function signup() {
      var email = document.getElementById('new-email').value;
      var password = document.getElementById('new-password').value;
      var category = document.getElementById('kategori').value;

      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(function(userCredential) {
          var user = userCredential.user;
          // Create a new user document in Firestore with the user's UID as the document ID
          return firebase.firestore().collection('users').doc(user.uid).set({
            email: email,
            category: category
          });
        })
        .then(function() {
          successMessage.innerHTML = 'Akun berhasil dibuat. Silakan masuk.';
          successMessage.style.display = 'block';
          // After successful signup, redirect the user to the category page
          window.location.href = '/items/category/' + category + '/';
        })
        .catch(function(error) {
          errorMessage.innerHTML = error.message;
          errorMessage.style.display = 'block';
        });
    }


    // Load category page dynamically using AJAX
    function loadCategoryPage(category) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          categoryContent.innerHTML = this.responseText;
        }
      };
      xhttp.open('GET', '/items/category/' + category + '/', true); // Replace with the correct URL for the category page
      xhttp.send();
    }

    // Check if user is already logged in
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        var categoryRef = firebase.firestore().collection('users').doc(user.uid);
        categoryRef.get()
          .then(function(doc) {
            if (doc.exists) {
              var category = doc.data().category;
              loadCategoryPage(user.uid); // Load the category page dynamically using AJAX

              // Check if the current URL is already the category page
              if (!window.location.href.includes('/items/category/' + user.uid + '/')) {
                window.location.href = '/items/category/' + user.uid + '/'; // Redirect to the category page
              }
            } else {
              showLoginForm();
            }
          })
          .catch(function(error) {
            showLoginForm();
          });
      } else {
        showLoginForm();
      }
    });
  </script>
</body>
</html>
