<!DOCTYPE html>
<html>
<head>
  <title>Edit Profile</title>
</head>
<body>
  <h1>Edit Profile</h1>
  
  <form id="edit-profile-form">
    <label for="first-name">First Name:</label>
    <input type="text" id="first-name" name="first-name">
    
    <label for="last-name">Last Name:</label>
    <input type="text" id="last-name" name="last-name">
    
    <label for="instagram">Instagram:</label>
    <input type="text" id="instagram" name="instagram">
    
    <label for="tiktok">TikTok:</label>
    <input type="text" id="tiktok" name="tiktok">
    
    <label for="bio">Bio:</label>
    <textarea id="bio" name="bio"></textarea>
    
    <label for="username">Username:</label>
    <input type="text" id="username" name="username">
    
    <button type="submit">Save</button>
  </form>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  
  <script>
    // Your Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyA_2_DrjTzs1cIOY9_5mloWYcdLxpsFq5c",
  authDomain: "koraa-id.firebaseapp.com",
  databaseURL: "https://koraa-id-default-rtdb.firebaseio.com",
  projectId: "koraa-id",
  storageBucket: "koraa-id.appspot.com",
  messagingSenderId: "360256061577",
  appId: "1:360256061577:web:5d9dbb92ff3313c7b48658",
  measurementId: "G-VJT00SD3NT"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Get the edit profile form element
    var editProfileForm = document.getElementById('edit-profile-form');

    // Add submit event listener to the form
    editProfileForm.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent form submission

      // Get the updated profile data
      var firstName = document.getElementById('first-name').value;
      var lastName = document.getElementById('last-name').value;
      var instagram = document.getElementById('instagram').value;
      var tiktok = document.getElementById('tiktok').value;
      var bio = document.getElementById('bio').value;
      var username = document.getElementById('username').value;

      // Update the user profile data in the database
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          var userRef = firebase.firestore().collection('users').doc(user.uid);

          // Update the user profile data in the database
          userRef.update({
            firstName: firstName,
            lastName: lastName,
            instagram: instagram,
            tiktok: tiktok,
            bio: bio
          })
          .then(function() {
            // Username updated successfully
            console.log('Profile updated successfully');

            // Update the username in the user's document
            userRef.update({ username: username })
              .then(function() {
                console.log('Username updated successfully');

                // Update items with the same author and username
                var itemsRef = firebase.firestore().collection('items');
                itemsRef.where('author', '==', user.uid).get()
                  .then(function(querySnapshot) {
                    querySnapshot.forEach(function(doc) {
                      var itemid = doc.id;
                      var itemRef = itemsRef.doc(itemid);
                      itemRef.update({ author: username })
                        .then(function() {
                          console.log('Item updated successfully');
                        })
                        .catch(function(error) {
                          console.log(error);
                        });
                    });
                  })
                  .catch(function(error) {
                    console.log(error);
                  });

                // Redirect to the user's profile page or any other desired page
                window.location.href = '/p/profile/'; // Replace '/user/profile/' with the correct URL for the user's profile page
              })
              .catch(function(error) {
                console.log(error);
                // Handle the error appropriately
                alert('Failed to update username');
              });
          })
          .catch(function(error) {
            console.log(error);
            // Handle the error appropriately
            alert('Failed to update profile');
          });
        } else {
          // User is not logged in, handle the scenario accordingly
        }
      });
    });

    // Load existing user profile data from Firestore
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        var userRef = firebase.firestore().collection('users').doc(user.uid);
        userRef.get()
          .then(function(doc) {
            if (doc.exists) {
              var firstNameInput = document.getElementById('first-name');
              var lastNameInput = document.getElementById('last-name');
              var instagramInput = document.getElementById('instagram');
              var tiktokInput = document.getElementById('tiktok');
              var bioInput = document.getElementById('bio');
              var usernameInput = document.getElementById('username');

              var data = doc.data();
              firstNameInput.value = data.firstName || '';
              lastNameInput.value = data.lastName || '';
              instagramInput.value = data.instagram || '';
              tiktokInput.value = data.tiktok || '';
              bioInput.value = data.bio || '';
              usernameInput.value = data.username || '';
            }
          })
          .catch(function(error) {
            console.log(error);
          });
      }
    });

  </script>
</body>
</html>
