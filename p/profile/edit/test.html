<!DOCTYPE html>
<html>
<head>
  <title>Edit Profile</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <h1>Edit Profile</h1>
  <form id="edit-profile-form">
    <label for="first-name">First Name:</label>
    <input type="text" id="first-name" name="first-name"><br>
    <label for="last-name">Last Name:</label>
    <input type="text" id="last-name" name="last-name"><br>

    <label for="instagram">Instagram:</label>
    <input type="text" id="instagram" name="instagram" value=""><br>

    <label for="tiktok">TikTok:</label>
    <input type="text" id="tiktok" name="tiktok" value=""><br>

    <label for="bio">Bio:</label>
    <textarea id="bio" name="bio"></textarea><br>

    <label for="profile-image">Profile Image:</label>
    <input type="file" id="profile-image" name="profile-image"><br>

    <button type="submit">Save Changes</button>
  </form>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script>
    // Initialize Firebase
    var firebaseConfig = {
        apiKey: "AIzaSyA_2_DrjTzs1cIOY9_5mloWYcdLxpsFq5c",
    authDomain: "koraa-id.firebaseapp.com",
    databaseURL: "https://koraa-id-default-rtdb.firebaseio.com",
    projectId: "koraa-id",
    storageBucket: "koraa-id.appspot.com",
    messagingSenderId: "360256061577",
    appId: "1:360256061577:web:5d9dbb92ff3313c7b48658",
    measurementId: "G-VJT00SD3NT"
    };
    firebase.initializeApp(firebaseConfig);

    // Get the edit profile form element
    var editProfileForm = document.getElementById('edit-profile-form');

    // Add submit event listener to the form
    editProfileForm.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent form submission

      // Get the updated profile data
      var firstName = document.getElementById('first-name').value;
      var lastName = document.getElementById('last-name').value;
      var instagram = document.getElementById('instagram').value;
      var tiktok = document.getElementById('tiktok').value;
      var bio = document.getElementById('bio').value;

      // Update the user profile data in the database
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          var userRef = firebase.firestore().collection('users').doc(user.displayName);

          // Get the selected profile image file
          var profileImage = document.getElementById('profile-image').files[0];

          // Create a storage reference for the profile image
          var storageRef = firebase.storage().ref().child('profile_images/' + user.displayName);

          // Upload the profile image file to the storage reference
          if (profileImage) {
            var uploadTask = storageRef.put(profileImage);

            // Get the download URL of the uploaded image and update the profile data
            uploadTask.then(function(snapshot) {
              return snapshot.ref.getDownloadURL();
            })
            .then(function(downloadURL) {
              // Update the user profile data in the database
              userRef.update({
                firstName: firstName,
                lastName: lastName,
                instagram: instagram,
                tiktok: tiktok,
                bio: bio,
                profileImage: downloadURL // Add the profile image URL to the profile data
              })
              .then(function() {
                // Profile updated successfully
                alert('Profile updated successfully');
                // Redirect to the user's profile page or any other desired page
                window.location.href = '/user/profile/'; // Replace '/user/profile/' with the correct URL for the user's profile page
              })
              .catch(function(error) {
                console.log(error);
                // Handle the error appropriately
                alert('Failed to update profile');
              });
            })
            .catch(function(error) {
              console.log(error);
              // Handle the error appropriately
              alert('Failed to upload profile image');
            });
          } else {
            // If no profile image is selected, update the profile data without the image URL
            userRef.update({
              firstName: firstName,
              lastName: lastName,
              instagram: instagram,
              tiktok: tiktok,
              bio: bio
            })
            .then(function() {
              // Profile updated successfully
              alert('Profile updated successfully');
              // Redirect to the user's profile page or any other desired page
              window.location.href = '/user/profile/'; // Replace '/user/profile/' with the correct URL for the user's profile page
            })
            .catch(function(error) {
              console.log(error);
              // Handle the error appropriately
              alert('Failed to update profile');
            });
          }
        } else {
          // User is not logged in, handle the scenario accordingly
        }
      });
    });

    // Load existing user profile data from Firestore
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        var userRef = firebase.firestore().collection('users').doc(user.displayName);
        userRef.get()
          .then(function(doc) {
            if (doc.exists) {
              var firstNameInput = document.getElementById('first-name');
              var lastNameInput = document.getElementById('last-name');
              var instagramInput = document.getElementById('instagram');
              var tiktokInput = document.getElementById('tiktok');
              var bioInput = document.getElementById('bio');

              var data = doc.data();
              firstNameInput.value = data.firstName || '';
              lastNameInput.value = data.lastName || '';
              instagramInput.value = data.instagram || '';
              tiktokInput.value = data.tiktok || '';
              bioInput.value = data.bio || '';
            }
          })
          .catch(function(error) {
            console.log(error);
          });
      }
    });
  </script>
</body>
</html>
