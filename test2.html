<!DOCTYPE html>
<html>
<head>
  <title>Informasi File</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <h1>Informasi File</h1>
  <ul id="fileList"></ul>
  <ul id="totalSizeInfo"></ul>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // Konfigurasi Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyA_2_DrjTzs1cIOY9_5mloWYcdLxpsFq5c",
    authDomain: "koraa-id.firebaseapp.com",
    databaseURL: "https://koraa-id-default-rtdb.firebaseio.com",
    projectId: "koraa-id",
    storageBucket: "koraa-id.appspot.com",
    messagingSenderId: "360256061577",
    appId: "1:360256061577:web:5d9dbb92ff3313c7b48658",
    measurementId: "G-VJT00SD3NT"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);

    // Memeriksa status login pengguna saat ini
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        var uid = user.uid; // Menggunakan uid pengguna sebagai username
        getFileInfo(uid);
      } else {
        console.log('Pengguna belum login');
      }
    });

    // Mendapatkan ukuran dan metadata file
    function getFileInfo(uid) {
      var storageRef = firebase.storage().ref('items/' + uid);
      storageRef.listAll().then(function(res) {
        if (res.items.length > 0) {
          var filePromises = res.items.map(function(itemRef) {
            return itemRef.getMetadata().then(function(metadata) {
              // Mengakses metadata file
              var namaFile = metadata.name;
              var ukuranFile = metadata.size;
              var tanggalUpload = metadata.timeCreated;

              // Mengubah ukuran file menjadi KB, MB, atau GB
              var ukuranFormatted = formatSize(ukuranFile);

              // Mengubah tanggal upload menjadi format yang diinginkan
              var tanggalFormatted = formatDate(tanggalUpload);

              // Menampilkan informasi file
              var fileInfoHTML = '<li class="folder-box d-flex align-items-center">' +
                '<div class="d-flex align-items-center files-list">' +
                '<div class="flex-shrink-0 file-left"><i class="f-22 fa fa-folder font-primary"></i></div>' +
                '<div class="flex-grow-1 ms-3">' +
                '<h6>' + namaFile + '</h6>' +
                '<p>' + tanggalFormatted + ', ' + ukuranFormatted + '</p>' +
                '</div>' +
                '</div>' +
                '</li>';

              return {
                fileInfoHTML: fileInfoHTML,
                ukuranFile: ukuranFile
              };
            });
          });

          Promise.all(filePromises).then(function(fileInfoArray) {
            var fileInfoHTML = fileInfoArray.map(function(fileInfoObj) {
              return fileInfoObj.fileInfoHTML;
            }).join('');
            var totalSize = fileInfoArray.reduce(function(acc, fileInfoObj) {
              return acc + fileInfoObj.ukuranFile;
            }, 0);
            var totalSizeFormatted = formatSize(totalSize);

            // Mendapatkan informasi plan pengguna dari Firestore
            getPlanFromFirestore(uid).then(function(plan) {
              var totalSizeInfo = '<li>' +
                '<div class="btn btn-outline-primary"><i data-feather="database"></i>Storage</div>' +
                '<div class="m-t-15">' +
                '<div class="progress sm-progress-bar mb-3">' +
                '<div class="progress-bar bg-primary" role="progressbar" style="width: 25%" ' +
                'aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>' +
                '</div>' +
                '<h6 class="f-w-500">' + totalSizeFormatted + ' of ' + getPlanStorageLimit(plan) + ' used</h6>' +
                '</div>' +
                '</li>';

              document.getElementById('fileList').innerHTML = fileInfoHTML;
              document.getElementById('totalSizeInfo').innerHTML = totalSizeInfo;

              // Memuat ikon Feather Icons
              feather.replace();
            }).catch(function(error) {
              console.error('Error:', error);
            });
          }).catch(function(error) {
            console.error('Error:', error);
          });
        } else {
          console.log('Tidak ada file yang ditemukan');
        }
      }).catch(function(error) {
        console.error('Error:', error);
      });
    }

    // Fungsi untuk mengubah ukuran file menjadi KB, MB, atau GB
    function formatSize(size) {
      if (size < 1024) {
        return size + ' bytes';
      } else if (size < 1024 * 1024) {
        return (size / 1024).toFixed(2) + ' KB';
      } else if (size < 1024 * 1024 * 1024) {
        return (size / (1024 * 1024)).toFixed(2) + ' MB';
      } else {
        return (size / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
      }
    }

    // Fungsi untuk mendapatkan batas penyimpanan berdasarkan plan
    function getPlanStorageLimit(plan) {
      if (plan === 'free') {
        return '100 GB';
      } else if (plan === 'silver') {
        return '200 GB';
      } else {
        return 'Unknown';
      }
    }

    // Fungsi untuk mendapatkan informasi plan pengguna dari Firestore
    function getPlanFromFirestore(uid) {
      return new Promise(function(resolve, reject) {
        var usersCollectionRef = firebase.firestore().collection('users');
        var userDocRef = usersCollectionRef.doc(uid);
        userDocRef.get().then(function(doc) {
          if (doc.exists) {
            var userData = doc.data();
            var plan = userData.plan; // Ganti dengan nama field yang sesuai di Firestore
            resolve(plan);
          } else {
            reject(new Error('Dokumen pengguna tidak ditemukan'));
          }
        }).catch(function(error) {
          reject(error);
        });
      });
    }

    // Fungsi untuk memformat tanggal
    function formatDate(tanggalUpload) {
      var date = new Date(tanggalUpload);

      var seconds = Math.floor((Date.now() - date) / 1000);
      var interval = Math.floor(seconds / 31536000);

      if (interval > 1) {
        return date.toLocaleDateString();
      } else if (interval === 1) {
        return '1 day ago';
      } else if (seconds >= 3600) {
        var hours = Math.floor(seconds / 3600);
        return hours + ' hours ago';
      } else if (seconds >= 60) {
        var minutes = Math.floor(seconds / 60);
        return minutes + ' minutes ago';
      } else {
        return seconds + ' seconds ago';
      }
    }
  </script>
</body>
</html>
