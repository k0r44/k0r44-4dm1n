// Get the edit profile form element
var editProfileForm = document.getElementById('edit-profile-form');

// Get the overlay element
var overlay = document.getElementById('overlay');

// Add submit event listener to the form
editProfileForm.addEventListener('submit', function(event) {
  event.preventDefault(); // Prevent form submission
  
  // Display the overlay loading
  overlay.style.display = 'block';
  
  // Get the updated profile data
  var firstName = document.getElementById('first-name').value;
  var lastName = document.getElementById('last-name').value;
  var occupation = document.getElementById('occupation').value;
  var company = document.getElementById('company').value;
  var location = document.getElementById('location').value;
  var city = document.getElementById('city').value;
  var websiteUrl = document.getElementById('website-url').value;

  var instagram = document.getElementById('instagram').value;
  var tiktok = document.getElementById('tiktok').value;
  var facebook = document.getElementById('facebook').value;
  var twitter = document.getElementById('twitter').value;
  var dribbble = document.getElementById('dribbble').value;
  var pinterest = document.getElementById('pinterest').value;
  var github = document.getElementById('github').value;
  var linkedin = document.getElementById('linkedin').value;
  var telegram = document.getElementById('telegram').value;
  var wordpress = document.getElementById('wordpress').value;

  var bio = document.getElementById('bio').value;
  var birthday = document.getElementById('birthday').value;

  var template = document.getElementById('template').value;

  // Update the user profile data in the database
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      var userRef = firebase.firestore().collection('users').doc(user.uid);

      // Get the selected profile image file
      var profileImage = document.getElementById('profile-image').files[0];

      // Create a storage reference for the profile image
      var storageRef = firebase.storage().ref().child('profile/' + user.uid);

      // Upload the profile image file to the storage reference
      if (profileImage) {
        var uploadTask = storageRef.put(profileImage);

        // Get the download URL of the uploaded image and update the profile data
        uploadTask.then(function(snapshot) {
          return snapshot.ref.getDownloadURL();
        })
        .then(function(downloadURL) {
          // Update the user profile data in the database
          userRef.update({
            firstName: firstName,
            lastName: lastName,
            occupation: occupation,
            company: company,
            location: location,
            city: city,
            websiteUrl: websiteUrl,

            instagram: instagram,
            tiktok: tiktok,
            facebook: facebook,
            twitter: twitter,
            dribbble: dribbble,
            pinterest: pinterest,
            github: github,
            linkedin: linkedin,
            telegram: telegram,
            wordpress: wordpress,
            
            bio: bio,
            birthday: birthday,
            profile: downloadURL, // Add the profile image URL to the profile data

            template: template
          })
          .then(function() {
            // Profile updated successfully
            alert('Profile updated successfully');
            // Redirect to the user's profile page or any other desired page
            window.location.href = '/p/profile/'; // Replace '/user/profile/' with the correct URL for the user's profile page
            
            // Hide the overlay loading
            overlay.style.display = 'none';
          })
          .catch(function(error) {
            console.log(error);
            // Handle the error appropriately
            alert('Failed to update profile');
            
            // Hide the overlay loading
            overlay.style.display = 'none';
          });
        })
        .catch(function(error) {
          console.log(error);
          // Handle the error appropriately
          alert('Failed to upload profile image');
          
          // Hide the overlay loading
          overlay.style.display = 'none';
        });
      } else {
        // If no profile image is selected, update the profile data without the image URL
        userRef.update({
          firstName: firstName,
          lastName: lastName,
          occupation: occupation,
          company: company,
          location: location,
          city: city,
          websiteUrl: websiteUrl,

          instagram: instagram,
          tiktok: tiktok,
          facebook: facebook,
          twitter: twitter,
          dribbble: dribbble,
          pinterest: pinterest,
          github: github,
          linkedin: linkedin,
          telegram: telegram,
          wordpress: wordpress,

          bio: bio,
          birthday: birthday,

          template: template
        })
        .then(function() {
          // Profile updated successfully
          alert('Profile updated successfully');
          // Redirect to the user's profile page or any other desired page
          window.location.href = '/p/profile/'; // Replace '/user/profile/' with the correct URL for the user's profile page
          
          // Hide the overlay loading
          overlay.style.display = 'none';
        })
        .catch(function(error) {
          console.log(error);
          // Handle the error appropriately
          alert('Failed to update profile');
          
          // Hide the overlay loading
          overlay.style.display = 'none';
        });
      }
    } else {
      // User is not logged in, handle the scenario accordingly
    }
  });
});

// Load existing user profile data from Firestore
firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    var userRef = firebase.firestore().collection('users').doc(user.uid);
    userRef.get()
      .then(function(doc) {
        if (doc.exists) {
          var firstNameInput = document.getElementById('first-name');
          var lastNameInput = document.getElementById('last-name');
          var occupationInput = document.getElementById('occupation');
          var companyInput = document.getElementById('company');
          var locationInput = document.getElementById('location');
          var cityInput = document.getElementById('city');
          var websiteUrlInput = document.getElementById('website-url');

          var instagramInput = document.getElementById('instagram');
          var tiktokInput = document.getElementById('tiktok');
          var facebookInput = document.getElementById('facebook');
          var twitterInput = document.getElementById('twitter');
          var dribbbleInput = document.getElementById('dribbble');
          var pinterestInput = document.getElementById('pinterest');
          var githubInput = document.getElementById('github');
          var linkedinInput = document.getElementById('linkedin');
          var telegramInput = document.getElementById('telegram');
          var wordpressInput = document.getElementById('wordpress');

          var bioInput = document.getElementById('bio');
          var birthdayInput = document.getElementById('birthday');
          var templateInput = document.getElementById('template');

          var data = doc.data();
          firstNameInput.value = data.firstName || '';
          lastNameInput.value = data.lastName || '';
          occupationInput.value = data.occupation || '';
          companyInput.value = data.company || '';
          locationInput.value = data.location || '';
          cityInput.value = data.city || '';
          websiteUrlInput.value = data.websiteUrl || '';

          instagramInput.value = data.instagram || '';
          tiktokInput.value = data.tiktok || '';
          facebookInput.value = data.facebook || '';
          twitterInput.value = data.twitter || '';
          dribbbleInput.value = data.dribbble || '';
          pinterestInput.value = data.pinterest || '';
          githubInput.value = data.github || '';
          linkedinInput.value = data.linkedin || '';
          telegramInput.value = data.telegram || '';
          wordpressInput.value = data.wordpress || '';

          bioInput.value = data.bio || '';
          birthdayInput.value = data.birthday || '';

          templateInput.value = data.template || '';

          $("#location").trigger('change');
          $("#template").trigger('change');
          $("#location").trigger('change');

          // Update the 'item-picture' element with the profile picture URL or a default image
          var pictureElement = document.getElementsByClassName('author-profile')[0];
          var pictureURL = data.profile || 'https://www.koraa.my.id/assets/img/logo/koraa.png'; // Default image URL
          pictureElement.src = pictureURL;

          // Update the 'item-username' element with the username
          document.getElementsByClassName('author-name')[0].textContent = data.username || '';
          document.getElementsByClassName('author-category')[0].textContent = data.category || '';
          document.getElementsByClassName('author-bio')[0].innerHTML = data.bio || '';

         
        }
      })
      .catch(function(error) {
        console.log(error);
      });
  }
});

$(document).ready(function() {
  $("#template").on("change", function() {
      if ($(this).val() === "v1") {
          var link = $("<a>")
              .text("View Template V1")
              .attr("href", "https://www.koraa.my.id/user/?author=demov1")
              .attr("target", "_blank");
          $("a.view-link").remove();
          $(".view").empty().append(link.addClass("view-link"));
      } else if ($(this).val() === "v2") {
          var link = $("<a>")
              .text("View Template V2")
              .attr("href", "https://www.koraa.my.id/user/?author=demov2")
              .attr("target", "_blank");
          $("a.view-link").remove();
          $(".view").empty().append(link.addClass("view-link"));
      } else if ($(this).val() === "v3") {
          var link = $("<a>")
              .text("View Template V3")
              .attr("href", "https://www.koraa.my.id/user/?author=demov3")
              .attr("target", "_blank");
          $("a.view-link").remove();
          $(".view").empty().append(link.addClass("view-link"));
      }
  });
});