// Get the edit profile form element
var editProfileForm = document.getElementById('edit-profile-form');

// Get the overlay element
var overlay = document.getElementById('overlay');

// Add submit event listener to the form
editProfileForm.addEventListener('submit', function(event) {
  event.preventDefault(); // Prevent form submission
  
  // Display the overlay loading
  overlay.style.display = 'block';
  
  // Get the updated profile data
  var firstName = document.getElementById('first-name').value;
  var lastName = document.getElementById('last-name').value;
  var instagram = document.getElementById('instagram').value;
  var tiktok = document.getElementById('tiktok').value;
  var bio = document.getElementById('bio').value;

  // Update the user profile data in the database
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      var userRef = firebase.firestore().collection('users').doc(user.displayName);

      // Get the selected profile image file
      var profileImage = document.getElementById('profile-image').files[0];

      // Create a storage reference for the profile image
      var storageRef = firebase.storage().ref().child('profile/' + user.displayName);

      // Upload the profile image file to the storage reference
      if (profileImage) {
        var uploadTask = storageRef.put(profileImage);

        // Get the download URL of the uploaded image and update the profile data
        uploadTask.then(function(snapshot) {
          return snapshot.ref.getDownloadURL();
        })
        .then(function(downloadURL) {
          // Update the user profile data in the database
          userRef.update({
            firstName: firstName,
            lastName: lastName,
            instagram: instagram,
            tiktok: tiktok,
            bio: bio,
            profile: downloadURL // Add the profile image URL to the profile data
          })
          .then(function() {
            // Profile updated successfully
            alert('Profile updated successfully');
            // Redirect to the user's profile page or any other desired page
            window.location.href = '/p/profile/'; // Replace '/user/profile/' with the correct URL for the user's profile page
            
            // Hide the overlay loading
            overlay.style.display = 'none';
          })
          .catch(function(error) {
            console.log(error);
            // Handle the error appropriately
            alert('Failed to update profile');
            
            // Hide the overlay loading
            overlay.style.display = 'none';
          });
        })
        .catch(function(error) {
          console.log(error);
          // Handle the error appropriately
          alert('Failed to upload profile image');
          
          // Hide the overlay loading
          overlay.style.display = 'none';
        });
      } else {
        // If no profile image is selected, update the profile data without the image URL
        userRef.update({
          firstName: firstName,
          lastName: lastName,
          instagram: instagram,
          tiktok: tiktok,
          bio: bio
        })
        .then(function() {
          // Profile updated successfully
          alert('Profile updated successfully');
          // Redirect to the user's profile page or any other desired page
          window.location.href = '/p/profile/'; // Replace '/user/profile/' with the correct URL for the user's profile page
          
          // Hide the overlay loading
          overlay.style.display = 'none';
        })
        .catch(function(error) {
          console.log(error);
          // Handle the error appropriately
          alert('Failed to update profile');
          
          // Hide the overlay loading
          overlay.style.display = 'none';
        });
      }
    } else {
      // User is not logged in, handle the scenario accordingly
    }
  });
});

// Load existing user profile data from Firestore
firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      var userRef = firebase.firestore().collection('users').doc(user.displayName);
      userRef.get()
        .then(function(doc) {
          if (doc.exists) {
            var firstNameInput = document.getElementById('first-name');
            var lastNameInput = document.getElementById('last-name');
            var instagramInput = document.getElementById('instagram');
            var tiktokInput = document.getElementById('tiktok');
            var bioInput = document.getElementById('bio');
  
            var data = doc.data();
            firstNameInput.value = data.firstName || '';
            lastNameInput.value = data.lastName || '';
            instagramInput.value = data.instagram || '';
            tiktokInput.value = data.tiktok || '';
            bioInput.value = data.bio || '';
  
            // Update the 'item-picture' element with the profile picture URL or a default image
            var pictureElement = document.getElementsByClassName('author-profile')[0];
            var pictureURL = data.profile || 'https://www.koraa.my.id/assets/img/logo/koraa.png'; // Default image URL
            pictureElement.src = pictureURL;
            
            // Update the 'item-username' element with the username
            document.getElementsByClassName('author-name')[0].textContent = data.username || '';
            document.getElementsByClassName('author-category')[0].textContent = data.category || '';
            document.getElementsByClassName('author-bio')[0].innerHTML = data.bio || '';
          }
        })
        .catch(function(error) {
          console.log(error);
        });
    }
});
