
// Mengambil referensi Firestore
const db = firebase.firestore();

// Get user details elements
var userfullNameText = document.getElementsByClassName('user-fullname')[0];
var userEmailText = document.getElementsByClassName('user-email')[0];
var userCategoryText = document.getElementsByClassName('user-category')[0];
var userPictureSRC = document.getElementsByClassName('user-pic')[0];
var usernameText = document.getElementsByClassName('username')[0];
var signupTimeText = document.getElementsByClassName('signup-time')[0];
var planExpirationText = document.getElementsByClassName('plan-expiration')[0];
var userLinksText = document.getElementsByClassName('user-links')[0];
var userBioText = document.getElementsByClassName('user-bio')[0];

// Set user details and login time
firebase.auth().onAuthStateChanged(function (user) {
  if (user) {
    var author = user.uid; // Menggunakan displayName sebagai nilai author
    var categoryRef = firebase.firestore().collection('users').doc(author);
    categoryRef.get()
      .then(function (doc) {
        if (doc.exists) {

          var firstName = doc.data().firstName;
          var lastName = doc.data().lastName;

          if (firstName || lastName) {
            userfullNameText.textContent = (firstName ? firstName + " " : "") + (lastName ? lastName : "");
          } else {
            userfullNameText.textContent = "By Koraa";
          }

          userEmailText.textContent = user.email;
          userCategoryText.textContent = doc.data().category;

          // Cek apakah data profile tersedia
          if (doc.data().profile) {
            userPictureSRC.src = doc.data().profile;
          } else {
            userPictureSRC.src = 'https://www.koraa.my.id/assets/img/logo/koraa.png'; // Menggunakan gambar default jika tidak ada data profile
          }

          usernameText.textContent = doc.data().username;
          signupTimeText.textContent = doc.data().signupTime;

          // Cek apakah data planExpiration tersedia
          if (doc.data().planExpiration) {
            planExpirationText.textContent = doc.data().planExpiration; // Tampilkan waktu saat ini
          } else {
            planExpirationText.textContent = "Plan tidak tersedia";
          }

          // Create a link element
          var userLinksLink = document.createElement('a');
          userLinksLink.href = "https://www.koraa.my.id/user/?author=" + doc.data().username;
          userLinksLink.textContent = "https://www.koraa.my.id/user/?author=" + doc.data().username;
          userLinksLink.target = "_blank";

          // Clear previous content and append the link element
          userLinksText.innerHTML = '';
          userLinksText.appendChild(userLinksLink);

          // Cek apakah data bio tersedia
          if (doc.data().bio) {
            userBioText.innerHTML = doc.data().bio;
          } else {
            userBioText.textContent = "Bio tidak tersedia";
          }

          // Panggil fungsi untuk mendapatkan item-item pengguna
          getUserItems(author);
        } else {
          userfullNameText.textContent = "User not logged in";
          userEmailText.textContent = "Email not available";
          userCategoryText.textContent = "Category not available";
          signupTimeText.textContent = "";
          planExpirationText.textContent = "User not logged in";
          userBioText.textContent = "User not logged in";

          // Add click event listener to redirect to login page
          loginTimeText.addEventListener('click', function () {
            window.location.href = '/auth/login/'; // Ganti '/login' dengan URL yang benar untuk halaman login
          });
        }
      })
      .catch(function (error) {
        console.log(error);
      });
  } else {
    userEmailText.textContent = "User not logged in";
    userCategoryText.textContent = "";
    planExpirationText.textContent = "User not logged in";
    signupTimeText.textContent = "User not logged in";
    loginTimeText.textContent = "User not logged in";

    // Add click event listener to redirect to login page
    userEmailText.addEventListener('click', function () {
      window.location.href = '/auth/login/'; // Ganti '/login' dengan URL yang benar untuk halaman login
    });

    signupTimeText.addEventListener('click', function () {
      window.location.href = '/auth/login/'; // Ganti '/login' dengan URL yang benar untuk halaman login
    });

    loginTimeText.addEventListener('click', function () {
      window.location.href = '/auth/login/'; // Ganti '/login' dengan URL yang benar untuk halaman login
    });
  }
});

// Get logout button element
var logoutButton = document.getElementById('logout-button');

// Add event listener to logout button
logoutButton.addEventListener('click', function () {
  firebase.auth().signOut()
    .then(function () {
      // Redirect to the login page after successful logout
      window.location.href = '/auth/login/'; // Ganti '/login' dengan URL yang benar untuk halaman login
    })
    .catch(function (error) {
      console.log(error);
    });
});
